<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LibraryHub - Login</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/favicon.svg" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&amp;family=Caveat:wght@400;500;600;700&amp;display=optional"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3A86FF",
                        "secondary": "#FFBE0B",
                        "background-light": "#F8F9FA",
                        "background-dark": "#111921",
                        "text-light": "#212529",
                        "text-dark": "#f8f9fa",
                        "border-light": "#DEE2E6",
                        "border-dark": "#343a40"
                    },
                    fontFamily: {
                        "display": ["'DM Sans'", "system-ui", "sans-serif"],
                        "heading": ["'Caveat'", "system-ui", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }

        header {
            min-height: 60px;
        }
    </style>
    <script type="module" src="/src/components/header.js"></script>
</head>

<body class="min-h-screen bg-background-dark text-text-dark">
    <header id="header"></header>

    <main
        class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 flex items-center justify-center min-h-[calc(100vh-60px)]">
        <div class="w-full max-w-md">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-border-dark">
                <h1
                    class="font-heading text-4xl font-normal leading-snug tracking-tight text-text-light dark:text-text-dark mb-2 text-center">
                    Welcome Back
                </h1>
                <p class="text-gray-600 dark:text-gray-400 text-center mb-8">Sign in to your account</p>

                <form id="login-form" class="space-y-6">
                    <div id="error-message"
                        class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg text-sm">
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-text-light dark:text-text-dark mb-2">
                            Email
                        </label>
                        <input type="email" id="email" name="email" required
                            class="w-full px-4 py-3 rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-gray-700 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-colors"
                            placeholder="your.email@example.com" />
                    </div>

                    <div>
                        <label for="password"
                            class="block text-sm font-medium text-text-light dark:text-text-dark mb-2">
                            Password
                        </label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required
                                class="w-full px-4 py-3 pr-12 rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-gray-700 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-colors"
                                placeholder="Enter your password" />
                            <button type="button" id="toggle-password-login"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors"
                                aria-label="Toggle password visibility">
                                <span class="material-symbols-outlined text-xl">visibility</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-primary text-white py-3 px-6 rounded-lg font-medium hover:bg-primary/90 transition-colors shadow-md">
                        Sign In
                    </button>
                </form>

                <div class="mt-4 text-center">
                    <button id="forgot-password-btn" class="text-sm text-primary hover:underline font-medium">
                        Forgot Password?
                    </button>
                </div>

                <p class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                    Don't have an account?
                    <a href="signup.html" class="text-primary hover:underline font-medium">Sign up</a>
                </p>
            </div>
        </div>
    </main>

    <script type="module">
        import { login, forgotPassword, resetPassword } from '/src/services/auth.js';

        // Toggle password visibility for login page
        const togglePasswordBtn = document.getElementById('toggle-password-login');
        const passwordInput = document.getElementById('password');
        if (togglePasswordBtn && passwordInput) {
            togglePasswordBtn.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                const icon = togglePasswordBtn.querySelector('.material-symbols-outlined');
                icon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorDiv = document.getElementById('error-message');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitButton = e.target.querySelector('button[type="submit"]');

            // Hide error message
            errorDiv.classList.add('hidden');

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Signing in...';

            try {
                await login(email, password);
                // Existing users go straight to home
                window.location.href = 'index.html';
            } catch (error) {
                // Show error message
                errorDiv.textContent = error.message || 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Sign In';
            }
        });

        // Forgot password functionality
        document.getElementById('forgot-password-btn')?.addEventListener('click', () => {
            showForgotPasswordModal();
        });

        function showForgotPasswordModal() {
            const modal = document.createElement('div');
            modal.id = 'forgot-password-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 max-w-md w-full mx-4 border border-border-light dark:border-border-dark">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-heading text-2xl font-medium text-text-light dark:text-text-dark">Forgot Password</h2>
                        <button id="close-forgot-password-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div id="forgot-password-step-1">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Enter your email address and we'll send you a password reset link.</p>
                        <form id="forgot-password-form" class="space-y-4">
                            <div id="forgot-password-error" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg text-sm"></div>
                            <div id="forgot-password-success" class="hidden bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 px-4 py-3 rounded-lg text-sm"></div>
                            <div>
                                <label class="block text-sm font-medium text-text-light dark:text-text-dark mb-2">Email</label>
                                <input type="email" id="forgot-email" required
                                    class="w-full px-4 py-2 rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-gray-700 text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                />
                            </div>
                            <div class="flex gap-3">
                                <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">Send Reset Email</button>
                                <button type="button" id="cancel-forgot-password" class="px-4 py-2 rounded-lg border border-border-light dark:border-border-dark hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle close
            const closeModal = () => modal.remove();
            document.getElementById('close-forgot-password-modal')?.addEventListener('click', closeModal);
            document.getElementById('cancel-forgot-password')?.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Handle forgot password form
            document.getElementById('forgot-password-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const errorDiv = document.getElementById('forgot-password-error');
                const submitBtn = e.target.querySelector('button[type="submit"]');

                errorDiv.classList.add('hidden');

                const email = document.getElementById('forgot-email').value;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';

                try {
                    const result = await forgotPassword(email);
                    // Show success message
                    const successDiv = document.getElementById('forgot-password-success');
                    successDiv.textContent = result.message || 'If the email exists, a password reset link has been sent to your email. Please check your inbox.';
                    successDiv.classList.remove('hidden');
                    errorDiv.classList.add('hidden');

                    // Clear the email input
                    document.getElementById('forgot-email').value = '';

                    // Change button to close
                    submitBtn.textContent = 'Close';
                    submitBtn.onclick = () => {
                        modal.remove();
                    };

                    // Auto-close after 5 seconds
                    setTimeout(() => {
                        modal.remove();
                    }, 5000);
                } catch (error) {
                    errorDiv.textContent = error.message || 'Failed to send reset email. Please try again.';
                    errorDiv.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Email';
                }
            });

        }
    </script>
</body>

</html>