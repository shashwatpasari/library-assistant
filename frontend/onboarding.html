<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LibraryHub - Customize Your Experience</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&amp;family=Caveat:wght@400;500;600;700&amp;display=optional"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3A86FF",
                        "secondary": "#FFBE0B",
                        "background-light": "#F8F9FA",
                        "background-dark": "#111921",
                        "text-light": "#212529",
                        "text-dark": "#f8f9fa",
                    },
                    fontFamily: {
                        "display": ["'DM Sans'", "system-ui", "sans-serif"],
                        "heading": ["'Caveat'", "system-ui", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .step-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .hidden-step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .active-step {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        .genre-pill.selected {
            background-color: #3A86FF;
            color: white;
            border-color: #3A86FF;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen flex items-center justify-center p-4">

    <div
        class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
        <!-- Progress Bar -->
        <div class="bg-gray-200 dark:bg-gray-700 h-2 w-full">
            <div id="progress-bar" class="bg-primary h-full w-[25%] transition-all duration-300"></div>
        </div>

        <div class="p-8 md:p-12">
            <div id="wizard-form">

                <!-- STEP 1: GENRES -->
                <div id="step-1" class="step-content active-step">
                    <h2 class="font-heading text-4xl mb-2 text-primary">What do you love to read?</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8">Select 3 or more genres to get better
                        recommendations.</p>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                        <!-- Chips generated by JS -->
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Sci-Fi">üöÄ Sci-Fi</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Fantasy">üßô‚Äç‚ôÇÔ∏è Fantasy</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Mystery">üîç Mystery</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Thriller">üò± Thriller</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Romance">üíò Romance</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="History">üìú History</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Biography">üë§ Biography</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Self-Help">üå± Self-Help</button>
                        <button
                            class="genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            data-value="Business">üíº Business</button>
                    </div>
                </div>

                <!-- STEP 2: PACING & TONE -->
                <div id="step-2" class="step-content hidden-step">
                    <h2 class="font-heading text-4xl mb-2 text-primary">Set the Vibe</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8">How do you like your stories?</p>

                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-bold mb-3">Pacing</label>
                            <input type="range" min="1" max="3" value="2"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                id="pacing-slider">
                            <div class="flex justify-between text-xs text-gray-500 mt-2">
                                <span>Slow burn</span>
                                <span>Moderate</span>
                                <span>Fast-paced</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-3">Tone</label>
                            <div class="flex gap-4">
                                <button
                                    class="tone-btn flex-1 py-3 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all text-center"
                                    data-value="Light">
                                    ‚òÄÔ∏è Light & Fun
                                </button>
                                <button
                                    class="tone-btn flex-1 py-3 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all text-center"
                                    data-value="Dark">
                                    üåë Dark & Gritty
                                </button>
                                <button
                                    class="tone-btn flex-1 py-3 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all text-center"
                                    data-value="Emotional">
                                    ü•∫ Emotional
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: DEALBREAKERS -->
                <div id="step-3" class="step-content hidden-step">
                    <h2 class="font-heading text-4xl mb-2 text-primary">Any Dealbreakers?</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8">What should we avoid showing you?</p>

                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2">Triggers / Topics to Avoid</label>
                        <input type="text" id="triggers-input"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-transparent focus:ring-2 focus:ring-primary outline-none"
                            placeholder="e.g. Violence, Horror, Spiders">
                        <p class="text-xs text-gray-400 mt-2">Separate multiple items with commas.</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2">Disliked Genres</label>
                        <select id="disliked-genre-select"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-transparent focus:ring-2 focus:ring-primary outline-none">
                            <option value="">None</option>
                            <option value="Horror">Horror</option>
                            <option value="Romance">Romance</option>
                            <option value="History">History</option>
                        </select>
                    </div>
                </div>

                <!-- STEP 4: GOALS -->
                <div id="step-4" class="step-content hidden-step">
                    <h2 class="font-heading text-4xl mb-2 text-primary">Reading Goals</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8">Let's set a target for this month.</p>

                    <div class="flex items-center justify-center gap-6 mb-10">
                        <button id="dec-goal"
                            class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center text-xl font-bold">-</button>
                        <div class="text-center">
                            <div id="goal-display" class="text-6xl font-bold font-heading text-primary">4</div>
                            <div class="text-sm text-gray-500 uppercase tracking-widest mt-2">Books / Month</div>
                        </div>
                        <button id="inc-goal"
                            class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                </div>

                <!-- NAVIGATION -->
                <div class="flex justify-between mt-12 pt-6 border-t border-gray-100 dark:border-gray-700">
                    <button id="prev-btn"
                        class="px-6 py-2 rounded-lg text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 font-medium invisible">Back</button>
                    <button id="next-btn"
                        class="px-8 py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-primary/90 transition-transform active:scale-95">Next
                        Step</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getToken } from './src/services/auth.js';

        // State
        let currentStep = 1;
        const totalSteps = 4;
        const preferences = {
            favorite_genres: [],
            pacing_preference: "Moderate",
            tone_preference: null,
            triggers_to_avoid: [],
            disliked_genres: [],
            reading_goals: { monthly_target: 4 },
            onboarding_completed: true
        };

        // DOM Elements
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const progressBar = document.getElementById('progress-bar');

        // --- Step 1: Genres ---
        document.querySelectorAll('.genre-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
                const genre = btn.dataset.value;
                if (btn.classList.contains('selected')) {
                    preferences.favorite_genres.push(genre);
                } else {
                    preferences.favorite_genres = preferences.favorite_genres.filter(g => g !== genre);
                }
            });
        });

        // --- Step 2: Pacing & Tone ---
        document.getElementById('pacing-slider').addEventListener('input', (e) => {
            const val = e.target.value;
            if (val == 1) preferences.pacing_preference = "Slow";
            if (val == 2) preferences.pacing_preference = "Moderate";
            if (val == 3) preferences.pacing_preference = "Fast";
        });

        document.querySelectorAll('.tone-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Clear others
                document.querySelectorAll('.tone-btn').forEach(b => {
                    b.classList.remove('bg-primary', 'text-white', 'border-transparent');
                    b.classList.add('border-gray-300', 'dark:border-gray-600');
                });

                // Select this
                btn.classList.remove('border-gray-300', 'dark:border-gray-600');
                btn.classList.add('bg-primary', 'text-white', 'border-transparent');
                preferences.tone_preference = btn.dataset.value;
            });
        });

        // --- Step 4: Goals ---
        const goalDisplay = document.getElementById('goal-display');
        document.getElementById('inc-goal').addEventListener('click', () => {
            preferences.reading_goals.monthly_target++;
            goalDisplay.textContent = preferences.reading_goals.monthly_target;
        });
        document.getElementById('dec-goal').addEventListener('click', () => {
            if (preferences.reading_goals.monthly_target > 1) {
                preferences.reading_goals.monthly_target--;
                goalDisplay.textContent = preferences.reading_goals.monthly_target;
            }
        });

        // --- Navigation ---
        function updateStep() {
            // Update Headers/Content
            document.querySelectorAll('.step-content').forEach((el, index) => {
                if (index + 1 === currentStep) {
                    el.classList.remove('hidden-step');
                    el.classList.add('active-step');
                } else {
                    el.classList.add('hidden-step');
                    el.classList.remove('active-step');
                }
            });

            // Update Progress
            progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

            // Buttons
            prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            nextBtn.textContent = currentStep === totalSteps ? 'Finish Profile' : 'Next Step';
        }

        nextBtn.addEventListener('click', async () => {
            // Step 3 Data Collection (Input field lookup)
            if (currentStep === 3) {
                const triggers = document.getElementById('triggers-input').value;
                preferences.triggers_to_avoid = triggers.split(',').map(t => t.trim()).filter(t => t);
                const disliked = document.getElementById('disliked-genre-select').value;
                if (disliked) preferences.disliked_genres = [disliked];
            }

            if (currentStep < totalSteps) {
                currentStep++;
                updateStep();
            } else {
                // Final Submit
                await submitPreferences();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateStep();
            }
        });

        async function submitPreferences() {
            const token = localStorage.getItem('auth_token'); // Using correct key from earlier fix
            if (!token) {
                alert("Please log in first.");
                window.location.href = 'login.html';
                return;
            }

            nextBtn.disabled = true;
            nextBtn.textContent = 'Saving...';

            try {
                const res = await fetch('http://localhost:8000/users/me/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(preferences)
                });

                if (res.ok) {
                    window.location.href = 'index.html';
                } else {
                    const err = await res.json();
                    alert("Error saving profile: " + (err.detail || "Unknown error"));
                    nextBtn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert("Network error.");
                nextBtn.disabled = false;
            }
        }
    </script>
</body>

</html>