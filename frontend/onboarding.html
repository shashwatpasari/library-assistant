<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LibraryHub - Customize Your Experience</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&amp;family=Caveat:wght@400;500;600;700&amp;display=optional"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3A86FF",
                        "secondary": "#FFBE0B",
                        "background-light": "#F8F9FA",
                        "background-dark": "#111921",
                        "text-light": "#212529",
                        "text-dark": "#f8f9fa",
                    },
                    fontFamily: {
                        "display": ["'DM Sans'", "system-ui", "sans-serif"],
                        "heading": ["'Caveat'", "system-ui", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .step-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .hidden-step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .active-step {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        .pill-btn.selected {
            background-color: #3A86FF;
            color: white;
            border-color: #3A86FF;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen flex items-center justify-center p-4">

    <main class="w-full flex items-center justify-center">
        <div
            class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
            <!-- Progress Bar -->
            <div class="bg-gray-200 dark:bg-gray-700 h-2 w-full">
                <div id="progress-bar" class="bg-primary h-full w-[20%] transition-all duration-300"></div>
            </div>

            <div class="p-8 md:p-12">
                <div id="wizard-form">

                    <!-- STEP 1: GENRES -->
                    <div id="step-1" class="step-content active-step">
                        <h2 class="font-heading text-4xl mb-2 text-primary">What do you love to read?</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Select 3 or more genres to get better
                            recommendations.</p>

                        <div id="genres-container" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Sci-Fi">üöÄ Sci-Fi</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Fantasy">üßô‚Äç‚ôÇÔ∏è Fantasy</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Mystery">üîç Mystery</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Thriller">üò± Thriller</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Romance">üíò Romance</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="History">üìú History</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Biography">üë§ Biography</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Self-Help">üå± Self-Help</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Business">üíº Business</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Horror">üëª Horror</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Young Adult">üìö Young Adult</button>
                            <button
                                class="pill-btn genre-pill border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Literary Fiction">‚ú® Literary Fiction</button>
                        </div>
                    </div>

                    <!-- STEP 2: THEMES -->
                    <div id="step-2" class="step-content hidden-step">
                        <h2 class="font-heading text-4xl mb-2 text-primary">What themes hook you?</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Pick themes that resonate with you.</p>

                        <div id="themes-container" class="flex flex-wrap gap-3 mb-8">
                            <!-- Will be populated from API -->
                            <div class="text-gray-400 text-sm">Loading themes...</div>
                        </div>
                    </div>

                    <!-- STEP 3: MOODS -->
                    <div id="step-3" class="step-content hidden-step">
                        <h2 class="font-heading text-4xl mb-2 text-primary">What mood are you in?</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Select the vibes you enjoy in books.</p>

                        <div id="moods-container" class="flex flex-wrap gap-3 mb-8">
                            <!-- Will be populated from API -->
                            <div class="text-gray-400 text-sm">Loading moods...</div>
                        </div>
                    </div>

                    <!-- STEP 4: PACING -->
                    <div id="step-4" class="step-content hidden-step">
                        <h2 class="font-heading text-4xl mb-2 text-primary">Set the Pace</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">How do you like your stories? Select all that
                            apply.</p>

                        <div id="pacing-container" class="flex flex-wrap gap-3 mb-8">
                            <button
                                class="pill-btn pacing-pill border border-gray-300 dark:border-gray-600 rounded-full py-3 px-6 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Slow">üê¢ Slow Burn</button>
                            <button
                                class="pill-btn pacing-pill border border-gray-300 dark:border-gray-600 rounded-full py-3 px-6 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Moderate">‚öñÔ∏è Moderate</button>
                            <button
                                class="pill-btn pacing-pill border border-gray-300 dark:border-gray-600 rounded-full py-3 px-6 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                data-value="Fast">üöÄ Fast-Paced</button>
                        </div>
                    </div>

                    <!-- STEP 5: GOALS -->
                    <div id="step-5" class="step-content hidden-step">
                        <h2 class="font-heading text-4xl mb-2 text-primary">Reading Goals</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Let's set a target for this month.</p>

                        <div class="flex items-center justify-center gap-6 mb-10">
                            <button id="dec-goal"
                                class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center text-xl font-bold">-</button>
                            <div class="text-center">
                                <div id="goal-display" class="text-6xl font-bold font-heading text-primary">4</div>
                                <div class="text-sm text-gray-500 uppercase tracking-widest mt-2">Books / Month</div>
                            </div>
                            <button id="inc-goal"
                                class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center text-xl font-bold">+</button>
                        </div>
                    </div>

                    <!-- NAVIGATION -->
                    <div class="flex justify-between mt-12 pt-6 border-t border-gray-100 dark:border-gray-700">
                        <button id="prev-btn"
                            class="px-6 py-2 rounded-lg text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 font-medium invisible">Back</button>
                        <button id="next-btn"
                            class="px-8 py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-primary/90 transition-transform active:scale-95">Next
                            Step</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { getToken } from './src/services/auth.js';

        // Dynamic API URL - works in both dev and production
        const hostname = window.location.hostname;
        const API_BASE = (hostname === 'localhost' || hostname === '127.0.0.1')
            ? 'http://localhost:8000'
            : '/api';

        // State
        let currentStep = 1;
        const totalSteps = 5;
        const preferences = {
            favorite_genres: [],
            preferred_themes: [],
            preferred_moods: [],
            pacing_preferences: [],
            reading_goals: { monthly_target: 4 },
            onboarding_completed: true
        };

        // DOM Elements
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const progressBar = document.getElementById('progress-bar');

        // --- Load themes and moods from API ---
        async function loadThemesAndMoods() {
            try {
                // Fetch available themes
                const themesRes = await fetch(`${API_BASE}/users/preferences/available-themes`);
                if (themesRes.ok) {
                    const themes = await themesRes.json();
                    renderPills('themes-container', themes, 'theme-pill', preferences.preferred_themes);
                }

                // Fetch available moods
                const moodsRes = await fetch(`${API_BASE}/users/preferences/available-moods`);
                if (moodsRes.ok) {
                    const moods = await moodsRes.json();
                    renderPills('moods-container', moods, 'mood-pill', preferences.preferred_moods);
                }
            } catch (e) {
                console.error('Failed to load themes/moods:', e);
                // Show fallback options
                renderPills('themes-container', ['redemption', 'survival', 'love', 'identity', 'adventure', 'family', 'friendship', 'power', 'revenge', 'discovery'], 'theme-pill', preferences.preferred_themes);
                renderPills('moods-container', ['cozy', 'tense', 'romantic', 'adventurous', 'melancholic', 'inspiring', 'dark', 'humorous', 'mysterious'], 'mood-pill', preferences.preferred_moods);
            }
        }

        function renderPills(containerId, items, className, selectedArray) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <button class="pill-btn ${className} border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors capitalize"
                    data-value="${item}">${item}</button>
            `).join('');

            // Add click handlers
            container.querySelectorAll(`.${className}`).forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                    const value = btn.dataset.value;
                    if (btn.classList.contains('selected')) {
                        selectedArray.push(value);
                    } else {
                        const idx = selectedArray.indexOf(value);
                        if (idx > -1) selectedArray.splice(idx, 1);
                    }
                });
            });
        }

        // --- Step 1: Genres ---
        document.querySelectorAll('.genre-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
                const genre = btn.dataset.value;
                if (btn.classList.contains('selected')) {
                    preferences.favorite_genres.push(genre);
                } else {
                    preferences.favorite_genres = preferences.favorite_genres.filter(g => g !== genre);
                }
            });
        });

        // --- Step 4: Pacing ---
        document.querySelectorAll('.pacing-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
                const pacing = btn.dataset.value;
                if (btn.classList.contains('selected')) {
                    preferences.pacing_preferences.push(pacing);
                } else {
                    preferences.pacing_preferences = preferences.pacing_preferences.filter(p => p !== pacing);
                }
            });
        });

        // --- Step 5: Goals ---
        const goalDisplay = document.getElementById('goal-display');
        document.getElementById('inc-goal').addEventListener('click', () => {
            preferences.reading_goals.monthly_target++;
            goalDisplay.textContent = preferences.reading_goals.monthly_target;
        });
        document.getElementById('dec-goal').addEventListener('click', () => {
            if (preferences.reading_goals.monthly_target > 1) {
                preferences.reading_goals.monthly_target--;
                goalDisplay.textContent = preferences.reading_goals.monthly_target;
            }
        });

        // --- Navigation ---
        function updateStep() {
            // Update Headers/Content
            document.querySelectorAll('.step-content').forEach((el, index) => {
                if (index + 1 === currentStep) {
                    el.classList.remove('hidden-step');
                    el.classList.add('active-step');
                } else {
                    el.classList.add('hidden-step');
                    el.classList.remove('active-step');
                }
            });

            // Update Progress
            progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

            // Buttons
            prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
            nextBtn.textContent = currentStep === totalSteps ? 'Finish Profile' : 'Next Step';
        }

        nextBtn.addEventListener('click', async () => {


            if (currentStep < totalSteps) {
                currentStep++;
                updateStep();
            } else {
                // Final Submit
                await submitPreferences();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateStep();
            }
        });

        async function submitPreferences() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert("Please log in first.");
                window.location.href = 'login.html';
                return;
            }

            nextBtn.disabled = true;
            nextBtn.textContent = 'Saving...';

            try {
                const res = await fetch(`${API_BASE}/users/me/preferences`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(preferences)
                });

                if (res.ok) {
                    window.location.href = 'index.html';
                } else {
                    const err = await res.json();
                    alert("Error saving profile: " + (err.detail || "Unknown error"));
                    nextBtn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert("Network error.");
                nextBtn.disabled = false;
            }
        }

        // Initialize
        loadThemesAndMoods();
    </script>
</body>

</html>